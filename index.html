import json
import html

def generate_changes_html(items, sources, base_url):
    # ... (other code)

    data_json = json.dumps(
        {"items": items, "sources": sources, "base_url": base_url}, ensure_ascii=False
    )
    # <script>内に生で埋めるので、終了タグだけ潰して安全化（HTMLエスケープはしない：JSONとして壊れる）
    data_json_safe = data_json.replace("</", "<\\/")

    template = """
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Changes</title>
<style>
  /* styles omitted for brevity */
</style>
</head>
<body>
  <h1>Changes</h1>
  <div id="empty">Loading...</div>
  <script id="data" type="application/json">__DATA_JSON__</script>
  <script>
    let data = {};
    try {
      data = JSON.parse(document.getElementById('data').textContent);
    } catch (e) {
      const elEmpty = document.getElementById('empty');
      if (elEmpty) {
        elEmpty.textContent = 'ERROR: ページ内データの読み込みに失敗しました（JSON parse）。changes.html を再生成してください。';
      }
      console.error(e);
      data = { items: [], sources: [] };
    }
    // ... rest of the script
  </script>
</body>
</html>
"""

    out_html = template.replace("__DATA_JSON__", data_json_safe)
    return out_html